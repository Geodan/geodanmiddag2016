<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/star-rating/star-rating.html">
<link rel="import" href="../bower_components/neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-out-animation.html">

<link href="../bower_components/iron-icons/maps-icons.html" rel="import">
<link href="../bower_components/iron-icons/image-icons.html" rel="import">

<link rel="import" href="./login-element.html">
<link rel="import" href="./cow-element.html">
<link rel="import" href="./geopos-element.html">

<script src="../bower_components/d3/d3.js" charset="utf-8"></script>
<script src="../bower_components/topojson/topojson.js"></script>
<script src="../bower_components/d3-plugins/geo/tile/tile.js"></script>
<script src="../bower_components/d3.mappu/dist/d3.mappu.js"></script>

<dom-module id="gmiddag-mobile">
<style>
#map {
	height: 100%;
	position: absolute;
	overflow: hidden;
	left: 0px;
	right: 0px;
	bottom: 0px;
	top: 0px;
}
#content {
	position: relative;
	height: 100%;
}

#locationbutton{
	position: fixed;
	bottom: 10px;
	left: 10px;
	z-index: 101;
}

#camerabutton{
	position: fixed;
	bottom: 10px;
	right: 10px;
	z-index: 101;
}

#camerainput{
	position: absolute;
	bottom: 0;
	right: 0;
	margin: 0;
	padding: 0;
	width: 50px;
	height: 50px;
	font-size: 20px;
	cursor: pointer;
	opacity: 0;
	filter: alpha(opacity=0);
	z-index: 101;
}

#spinner{
	position: absolute;
	top: 50%; left: 50%;
	transform: translate(-50%,-50%);
	z-index: 105;
}

#photopreview{
	width: 200px;
}

#toast {
	z-index: 101;
}

paper-dialog.warning {
	width: 200px;
	border: 2px solid;
	border-color: var(--paper-orange-500);
	background-color: var(--paper-light-orange-50);
	color: var(--paper-orange-500);
}

star-rating {
	display: block;
	position: relative;
	margin: -5px;
	left: 10px;
	color: #ff4081;
}


</style>
<template>
<!-- NON UI elements -->

	<carbon-location route="{{route}}"></carbon-location>

	<cow-element id='cowelement' username='{{username}}' groupid='{{groupid}}' userid='{{cowid}}' userfeatures='{{userfeatures}}' me='{{me}}'></cow-element>
	<geopos-element curposition='{{curpos}}'></geopos-element>


<div id='content'>

	<paper-dialog class='warning' modal id='groupdialog' opened="[[!groupid]]" entry-animation="scale-up-animation" exit-animation="fade-out-animation">
		<h2>Geen groep</h2>
		<div>
			Er is geen groep bekend in de URL
		</div>
	</paper-dialog>

	<paper-dialog modal id='logindialog' opened="[[!knownuser]]" entry-animation="scale-up-animation" exit-animation="fade-out-animation">
		<h2>Login</h2>
		<login-element username='{{username}}' userid='{{cowid}}' knownuser='{{knownuser}}'></login-element>
	</paper-dialog>

	<div id='map'></div>
	<paper-fab mini id="locationbutton" on-click="" icon="maps:my-location"></paper-fab>
	<paper-fab mini id="camerabutton" icon="image:camera"></paper-fab>
	<paper-spinner id="spinner"></paper-spinner><br>
	<paper-toast id="toast" text="{{msg}}"></paper-toast>
	<form id="photoForm">
		<input type="file" required id="camerainput" name="photo" accept="image/*" capture="camera" on-change="previewPhoto"/>
		<paper-dialog modal id="photoDialog" opened="{{showPhotoDialog}}" entry-animation="scale-up-animation" exit-animation="fade-out-animation">
			<img id="photopreview" src="">
			<star-rating id="starRating" stars="5" rate="{{photoRating}}"></star-rating>
			<div class="buttons">
				<paper-button dialog-dismiss on-click="resetForm">Cancel</paper-button>&nbsp;
				<paper-button dialog-confirm on-click="submitPhoto">Submit</paper-button>
			</div>
		</paper-dialog>
	</form>
</div>
</template>
</dom-module>

<script>
Polymer({
	is: 'gmiddag-mobile',
	properties: {
		map: {
			type: Object,
			notify: true
		},
		userfeatures: {
			type: Array
		},
		knownuser: {
			type: Boolean
		},
		curpos: {
			type: Array
		},
		me: {
			type: Object
		},
		showPhotoDialog: false,
		photoRating: 0,
		msg: '',
		route: {
			type: Object,
			observer: '_routeChanged'
		}
	},
	observers: [
		'_curposChanged(curpos,map,me)',
		'_usersChanged(userfeatures,userLayer)'
	],
	_routeChanged: function(route){
		this.groupid = route.__queryParams.group || false;
	},
	_usersChanged: function(users){
		this.userLayer.data = users;
	},
	_curposChanged: function(pos,map,me){
		map.center = pos;
		map.redraw();
		me.data('location', pos).sync();
		//TODO: add speed and totalDistance
	},

	ready:function(){
		var self = this;
		this.map = new d3.mappu.Map('map', {
					center: [4.90,52.36],
					zoom: 24,
					minZoom: 10,
					maxZoom: 30,
					projection: d3.geo.mercator()
			});

			var layer = new d3.mappu.RasterLayer('layer1', {
				ogc_type: 'tms',
				url: 'http://tile.stamen.com/toner-lite/{z}/{x}/{y}.png',
				opacity: 1
			}).addTo(this.map);

			var opacscale = d3.scale.linear().range([0,1]).domain([23,24]);
			var opacfunc = function(){
				return opacscale(self.map.zoom);
			}

			this.userLayer = new d3.mappu.VectorLayer('userLayer',{
				reproject: true,
				duration: 1000,
				labelStyle: {
					fill: 'steelBlue',
					stroke: 'none',
					opacity: opacfunc
				},
				style: {
					fill: 'steelBlue',
					strone: 'none'
				},
				labelfield: 'name'
			}).addTo(this.map);


	},

	attached: function(){
		this.map.resize();
	},

	previewPhoto: function() {
		var preview = this.$.photopreview;
		var file = this.$.camerainput.files[0];
		if(!file) return;
		
		var spinner = this.$.spinner;
		var reader = new FileReader();

		this.photoRating = 0;
		spinner.active = true;
		var self = this;
		reader.onloadend = function () {
			preview.src = reader.result;
			preview.onload = function() {
				spinner.active = false;
				self.showPhotoDialog = true;
			}
		};
		reader.onerror = function () {
			spinner.active = false;
			preview.src = '';
			self.status('Error loading image.');
			self.resetForm();
		};

		if (file) {
			reader.readAsDataURL(file);
		} else {
			preview.src = '';
			self.status('No image file selected.');
			self.resetForm();
		}
	},

	submitPhoto: function(){
		var file = this.$.camerainput.files[0];
		if(!file || !file.type.match('image.*')){
			this.status('Please select a photo.');
			return;
		}
		
		var formData = new FormData();
		// Add the file to the request.
		formData.append('photo', file, file.name);
		// Set up the request.
		var xhr = new XMLHttpRequest();
		// Open the connection.
		xhr.open('POST', '/geodandag/uploadphoto', true);
		
		// Set up a handler for when the request finishes.
		var self = this;
		xhr.onload = function () {
			if (xhr.status === 200) {
				self.status('Successfully uploaded photo.');
				var pos = xhr.responseText.indexOf('{');
				var response = JSON.parse(xhr.responseText.substr(pos));
				var photoID = response.filename;
				
				// add the photo to cow to notify peers
				var cowElement = self.$.cowelement;
				cowElement.addPhoto(photoID, self.photoRating);
				
				// reset form after successful upload
				self.resetForm();
			} else {
				self.status('Error uploading photo.');
				// upload failed: preview the photo again, so the user can resubmit
				self.previewPhoto();
			}
		};
		
		// send the ajax request
		xhr.send(formData);
	},
	
	resetForm: function(){
		this.$.photoForm.reset();
	},
	
	status: function(status){
		this.msg = status;
		this.$.toast.open();
	}
});
</script>
