<link rel="import" href="../bower_components/polymer/polymer.html">

<dom-module id="geopos-element">
<style>
</style>
<template>
</template>
</dom-module>

<script>
Polymer({
    is: 'geopos-element',
    properties: {
    	curposition: {
			type: Array,
			value: function(){return [5,52]}, //TODO: set to Utrecht
			notify: true,
			readonly:true
		},
		curtime: {
			type: Number,
			notify: true,
			value: function(){return new Date().getTime();},
			readonly: true
		},
		totaldistance: {
			type: Number,
			notify: true,
			value: 0,
			readonly: true
		},
		speed: {
			type: Number,
			notify: true,
			value: 0,
			readonly: true
		}
    },
    ready:function(){
		var self = this;
		var lastPos;
		var lastTime;
		// calculate distance in km between two lon/lat pairs
		function calculateDistance(pos1, pos2) {
			var R = 6371; // km
			var dLon = (pos2[0] - pos1[0]).toRad();
			var dLat = (pos2[1] - pos1[1]).toRad();
			var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
					Math.cos(pos1[1].toRad()) * Math.cos(pos2[1].toRad()) *
					Math.sin(dLon / 2) * Math.sin(dLon / 2);
			var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
			var d = R * c;
			return d;
		}
		Number.prototype.toRad = function() {
			return this * Math.PI / 180;
		}


		function updatePosition(position) {
			var curposition = [position.coords.longitude, position.coords.latitude];
			self.curposition = curposition;
			var curtime = new Date().getTime();
			self.curtime = curtime;

			if(!lastPos) {
				lastPos = curposition;
				lastTime = curtime;
				return;
			}

			var distance = calculateDistance(lastPos, curposition);
			self.distance = distance;
			self.totaldistance += distance;
			self.speed = distance / ((curtime - lastTime) / 3600000); // km/h

			if (distance < 0.010) return; // only update if distance >= 10m

			lastPos = curposition;
			lastTime = curtime;
		}

		navigator.geolocation.getCurrentPosition(updatePosition);
		setInterval(function(){
			navigator.geolocation.getCurrentPosition(updatePosition);
		}, 10000);

    }
});
</script>
