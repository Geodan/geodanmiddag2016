<!DOCTYPE html>
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF8">
<script src="bower_components/underscore/underscore-min.js"></script>
<script src="bower_components/cow/dist/cow.js"></script>

<style>

.inputName {
	width: 150px;
}

.inputAge {
	width: 30px;
}

#login-container {
	height: 100%;
	width: 100%;
	position: absolute;
	top: 0px; bottom: 0px; left: 0px; right: 0px;
	z-index: 9;
	background: rgb(255, 255, 255);
}

#login {
	z-index: 10;
	display: block;
	position: absolute;
	top: 50%; left: 50%;
	transform: translate(-50%,-50%);
	width: 300px;
	height: 300px;
	padding: 20px;
}

</style>
</head>
<body>

<script>

//constants
var COW_HERDNAME = 'geodanmiddag2016';
var COW_IP = 'websocket.geodan.nl';
var COW_PROTO = 'wss';
var COW_PORT = 443;
var COW_USER = 'Rubio';

//forward declarations
var userFeatures = [];
var userLayer;
var cowID;
var cowUser;
var lastPos;
var lastTime = new Date().getTime();
var speed = 0;
var totalDistance = 0;

//Create core object
var cow = new Cow.core({herdname: COW_HERDNAME});

//add a default socketserver
cow.socketservers({
	_id: 'default', 
	data: {
		protocol: COW_PROTO,
		ip: COW_IP, 
		port: COW_PORT,
		dir: COW_HERDNAME
	}
});
cow.socketserver('default');

var connection;
cow.connect().then(function(d){
	connection = d;
cowID = getCookie('cowID');
if(cowID) {
	cowUser = cow.users(cowID);
	if(!cowUser.data('name'))
		document.getElementById('login').style.display = 'none';
} else {
	cowUser = cow.users({}).sync();
	cowID = cowUser.id();
	setCookie('cowID', cowID, 1);
}
}, function(e){
	console.log('Connection error', e);
});


function start() {
	var userName = document.getElementById("userName").value
	var userAge = parseInt(document.getElementById("userName").value)
	if(userName.length < 2) {
		alert('Naam moet minimaal twee letters lang zijn.');
		return;
	}
	document.getElementById('login').style.display = 'none';
	
	cowUser.data('name', userName);
	navigator.geolocation.getCurrentPosition(updatePosition);
	setInterval(function(){ 
			navigator.geolocation.getCurrentPosition(updatePosition);
		}, 10000);
}

function updatePosition(position) {
	var curPos = [position.coords.longitude, position.coords.latitude];
	var curTime = new Date().getTime();
	
	if(!lastPos) {
		cowUser.data('location', curPos)
				.data('speed', speed)
				.data('distance', totalDistance)
				.sync();
		lastPos = curPos;
		lastTime = curTime;
		return;
	}
	
	var distance = calculateDistance(lastPos, curPos);
	totalDistance += distance;
	speed = distance / ((curTime - lastTime) / 3600000); // km/h

	if (distance < 0.010) return; // only update if distance >= 10m
	
	cowUser.data('location', curPos)
			.data('speed', speed)
			.data('distance', totalDistance)
			.sync();	
	lastPos = curPos;
	lastTime = curTime;
}

// calculate distance in km between two lon/lat pairs 
function calculateDistance(pos1, pos2) {
	var R = 6371; // km
	var dLon = (pos2[0] - pos1[0]).toRad(); 
	var dLat = (pos2[1] - pos1[1]).toRad();
	var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
			Math.cos(pos1[1].toRad()) * Math.cos(pos2[1].toRad()) * 
			Math.sin(dLon / 2) * Math.sin(dLon / 2); 
	var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)); 
	var d = R * c;
	return d;
}
Number.prototype.toRad = function() {
	return this * Math.PI / 180;
}

function setCookie(cname, cvalue, exdays) {
	var d = new Date();
	d.setTime(d.getTime() + (exdays*24*60*60*1000));
	var expires = "expires="+d.toUTCString();
	document.cookie = cname + "=" + cvalue + "; " + expires;
}

function getCookie(cname) {
	var name = cname + "=";
	var ca = document.cookie.split(';');
	for(var i=0; i<ca.length; i++) {
		var c = ca[i];
		while (c.charAt(0)==' ') c = c.substring(1);
		if (c.indexOf(name) == 0) return c.substring(name.length,c.length);
	}
	return "";
}

</script>
<div id="login-container">
	<div id="login">
		&nbsp;<br>
		Naam:&nbsp;<input class="inputName" size="15" id="userName" value=""><br><br>
		Leeftijd:&nbsp;<input class="inputAge" size="3" id="userAge" type="number" value=""><br><br>
		<button id="outline" onClick="start()">Start</button>
	</div>
</div>
<div id="main">
	Geodanmiddag 2016: tracking position...
</div>
</body>
</html>